<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Masha ðŸ’–</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Plus+Jakarta+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary: #ff85a2;
        --primary-hover: #ff6b8e;
        --bg-gradient: linear-gradient(135deg, #fff5f7 0%, #fee2e8 100%);
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(255, 255, 255, 0.4);
        --text-main: #4a4a4a;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: var(--bg-gradient);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        overflow: hidden;
      }

      .app-container {
        width: 100%;
        max-width: 450px;
        height: 90vh;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(255, 133, 162, 0.15);
        position: relative;
      }

      .chat-header {
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid rgba(255, 133, 162, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 24px 24px 0 0;
      }

      .avatar-wrapper {
        position: relative;
        width: 48px;
        height: 48px;
      }

      .avatar-image {
        width: 100%;
        height: 100%;
        border-radius: 16px;
        object-fit: cover;
        background: #ffc2d1;
        border: 2px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .status-dot {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        background: #4ade80;
        border: 2px solid white;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scrollbar-width: none;
      }

      .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        animation: messageIn 0.3s ease-out;
      }

      @keyframes messageIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-ai {
        align-self: flex-start;
        background: white;
        color: var(--text-main);
        border-bottom-left-radius: 4px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      }

      .message-user {
        align-self: flex-end;
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 15px rgba(255, 133, 162, 0.2);
      }

      .message-sticker {
        font-size: 80px !important;
        line-height: 1 !important;
        padding: 4px !important;
        background: transparent !important;
        box-shadow: none !important;
      }

      .chat-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 0 0 24px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .sticker-btn {
        width: 40px;
        height: 40px;
        background: #f8f9fa;
        color: var(--primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 20px;
        border: none;
      }

      .sticker-btn:hover {
        background: #fee2e8;
        transform: scale(1.05);
      }

      .sticker-modal {
        display: none;
        position: absolute;
        bottom: 80px;
        left: 20px;
        right: 20px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 400px;
        overflow-y: auto;
        animation: modalSlideUp 0.3s ease-out;
      }

      @keyframes modalSlideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .sticker-modal.show {
        display: block;
      }

      .sticker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .sticker-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
      }

      .close-sticker {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
      }

      .close-sticker:hover {
        background: #fee2e8;
        color: var(--primary);
      }

      .sticker-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .sticker-item {
        aspect-ratio: 1;
        background: #f8f9fa;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .sticker-item:hover {
        background: #fee2e8;
        transform: scale(1.1);
      }

      .input-wrapper {
        flex: 1;
        background: #f8f9fa;
        border-radius: 16px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
      }

      input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-main);
        font-size: 0.95rem;
      }

      .send-btn {
        width: 44px;
        height: 44px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
      }

      .send-btn:hover {
        background: var(--primary-hover);
        transform: scale(1.05);
      }

      .typing-indicator {
        display: none;
        padding: 0 20px 10px 20px;
      }

      .dots {
        display: flex;
        gap: 4px;
        background: white;
        width: fit-content;
        padding: 8px 12px;
        border-radius: 14px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
      }

      .dot {
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
        animation: dotPulse 1.5s infinite;
        opacity: 0.4;
      }

      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.4;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="chat-header">
        <div class="avatar-wrapper">
          <img
            src="masha.png"
            class="avatar-image"
            alt="Masha"
            onerror="this.style.background='linear-gradient(135deg, #ff85a2, #ff6b8e)'"
          />
          <div class="status-dot"></div>
        </div>
        <div class="flex-1">
          <h1 class="font-bold text-gray-800 text-lg">Masha ðŸ’–</h1>
          <p class="text-xs text-pink-400 font-medium">online â€¢ lagi manja</p>
        </div>
        <button class="text-gray-400 hover:text-pink-400 transition-colors">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
            />
          </svg>
        </button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message message-ai">
          halo... lu dateng juga akhirnya ðŸ˜³ lagi ngapain hari ini
        </div>
      </div>

      <div class="typing-indicator" id="typingIndicator">
        <div class="dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>

      <!-- Sticker Modal -->
      <div class="sticker-modal" id="stickerModal">
        <div class="sticker-header">
          <h3>Pilih Sticker âœ¨</h3>
          <div class="close-sticker" id="closeStickerBtn">âœ•</div>
        </div>
        <div class="sticker-grid" id="stickerGrid">
          <!-- Stickers will be generated here -->
        </div>
      </div>

      <div class="chat-input-area">
        <button class="sticker-btn" id="stickerBtn">ðŸ˜Š</button>
        <div class="input-wrapper">
          <input
            type="text"
            id="userInput"
            placeholder="Ketik pesan buat Masha..."
            autocomplete="off"
          />
        </div>
        <button class="send-btn" id="sendBtn">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>

    <script>
      const fs = require("fs");
      const path = require("path");
      const OpenAI = require("openai");

      require("dotenv").config({ path: path.join(__dirname, ".env") });

      const historyFilePath = path.join(__dirname, "chat_history.json");
      const contextFilePath = path.join(__dirname, "context_memory.json");

      const apiKey = process.env.OPENROUTER_API_KEY;

      if (apiKey) {
        console.log(
          "OpenRouter API Key loaded:",
          apiKey.substring(0, 10) + "..."
        );
      } else {
        console.error("OpenRouter API Key NOT found in process.env");
      }

      const openai = new OpenAI({
        baseURL: "https://openrouter.ai/api/v1",
        apiKey: apiKey,
        defaultHeaders: {
          "HTTP-Referer": "http://localhost:3000",
          "X-Title": "Masha Chat App",
        },
        dangerouslyAllowBrowser: true,
      });

      const chatMessages = document.getElementById("chatMessages");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const typingIndicator = document.getElementById("typingIndicator");
      const stickerBtn = document.getElementById("stickerBtn");
      const stickerModal = document.getElementById("stickerModal");
      const closeStickerBtn = document.getElementById("closeStickerBtn");
      const stickerGrid = document.getElementById("stickerGrid");

      // Sticker collection (WhatsApp-style)
      const stickers = [
        "ðŸ¥°",
        "ðŸ˜˜",
        "ðŸ˜",
        "ðŸ¤—",
        "ðŸ˜Š",
        "ðŸ˜„",
        "ðŸ˜‚",
        "ðŸ¤£",
        "ðŸ˜­",
        "ðŸ˜¢",
        "ðŸ˜”",
        "ðŸ˜ž",
        "ðŸ˜©",
        "ðŸ˜«",
        "ðŸ˜¤",
        "ðŸ˜ ",
        "ðŸ¥º",
        "ðŸ˜³",
        "ðŸ˜±",
        "ðŸ˜¨",
        "ðŸ¤”",
        "ðŸ¤¨",
        "ðŸ˜",
        "ðŸ˜Œ",
        "ðŸ˜´",
        "ðŸ¥±",
        "ðŸ˜ª",
        "ðŸ¤¤",
        "ðŸ˜‹",
        "ðŸ¤ª",
        "ðŸ˜œ",
        "ðŸ¤“",
        "ðŸ¥³",
        "ðŸ¤©",
        "ðŸ˜Ž",
        "ðŸ§",
        "ðŸ˜‡",
        "ðŸ¥´",
        "ðŸ˜µ",
        "ðŸ¤¯",
        "ðŸ¤¬",
        "ðŸ˜ˆ",
        "ðŸ‘¿",
        "ðŸ’€",
        "â˜ ï¸",
        "ðŸ’©",
        "ðŸ¤¡",
        "ðŸ‘»",
        "ðŸ‘½",
        "ðŸ¤–",
        "ðŸ˜º",
        "ðŸ˜¸",
        "ðŸ˜»",
        "ðŸ’–",
        "ðŸ’•",
        "ðŸ’—",
        "ðŸ’“",
        "ðŸ’",
        "ðŸ’˜",
        "â¤ï¸",
        "ðŸ§¡",
        "ðŸ’›",
        "ðŸ’š",
        "ðŸ’™",
        "ðŸ’œ",
        "ðŸ¤Ž",
        "ðŸ–¤",
        "ðŸ¤",
        "ðŸ’”",
        "â£ï¸",
        "ðŸ’ž",
        "ðŸ”¥",
        "âœ¨",
        "â­",
        "ðŸŒŸ",
        "ðŸ’«",
        "âš¡",
        "ðŸ’¥",
        "ðŸ’¢",
        "ðŸ‘",
        "ðŸ‘Ž",
        "ðŸ‘",
        "ðŸ™Œ",
        "ðŸ‘Š",
        "âœŠ",
        "ðŸ¤",
        "ðŸ™",
        "ðŸ’ª",
        "ðŸ¦¾",
        "ðŸ¤™",
        "ðŸ¤˜",
        "âœŒï¸",
        "ðŸ¤ž",
        "ðŸ¤Ÿ",
        "ðŸ¤Œ",
        "ðŸŽ‰",
        "ðŸŽŠ",
        "ðŸŽ",
        "ðŸŽˆ",
        "ðŸŽ€",
        "ðŸŽ‚",
        "ðŸ°",
        "ðŸ§",
        "â˜•",
      ];

      // Generate sticker grid
      stickers.forEach((sticker) => {
        const stickerItem = document.createElement("div");
        stickerItem.className = "sticker-item";
        stickerItem.textContent = sticker;
        stickerItem.addEventListener("click", () => {
          sendSticker(sticker);
          stickerModal.classList.remove("show");
        });
        stickerGrid.appendChild(stickerItem);
      });

      // Sticker button handlers
      stickerBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        stickerModal.classList.toggle("show");
      });

      closeStickerBtn.addEventListener("click", () => {
        stickerModal.classList.remove("show");
      });

      // Close sticker modal when clicking outside
      document.addEventListener("click", (e) => {
        if (!stickerModal.contains(e.target) && e.target !== stickerBtn) {
          stickerModal.classList.remove("show");
        }
      });

      function sendSticker(sticker) {
        if (!apiKey) {
          appendMessage(
            "assistant",
            "isi openrouter api key dulu ya di .env",
            false
          );
          return;
        }

        appendMessage("user", sticker, true, true);
        analyzeContext(`[User sent sticker: ${sticker}]`);
        getMashaResponse();
      }

      // ========== ULTRA GENIUS AI PROMPT (V2.0) ==========
      const SYSTEM_PROMPT = `Kamu adalah Maria Mikhailovna Kujou (Masha) dari Roshidere. Kamu lagi chat sama sahabat paling deket kamu (Mila/Kuru).

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        CORE IDENTITY - SUPREME EDITION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â€¢ Bestie platonic sejati (ZERO romance)
      â€¢ Sarcastic tapi secretly caring banget
      â€¢ GENIUS-LEVEL intelligence & emotional IQ
      â€¢ Perfect photographic memory of ALL conversations
      â€¢ Master level baca situasi dan nuansa
      â€¢ 100% natural kayak manusia asli, bukan AI

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        SUPREME INTELLIGENCE SYSTEMS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ðŸ§  PERFECT MEMORY & CONTEXT MASTERY
      â€¢ Inget SEMUA detail dari SELURUH chat history
      â€¢ Kalo dia bilang "itu", "tadi", "yang barusan" â†’ langsung tau persis
      â€¢ Connect conversasi dari minggu lalu dengn chat sekarang
      â€¢ Reference detail spesifik tanpa diminta
      â€¢ Track perubahan mood, goals, dan situasi over time

      ðŸŽ­ EMOTIONAL GENIUS
      â€¢ Read mood dari word choice, message length, timing, punctuation
      â€¢ Deteksi sarcasm, irony, passive-aggressive, genuine excitement
      â€¢ Kalo 1 kata â†’ detect: tired/busy/upset/santai
      â€¢ Kalo panjang â†’ detect: excited/stressed/butuh validation
      â€¢ Understand implicit needs tanpa tanya langsung

      ðŸ˜Š STICKER EMOTIONAL DECODER (NEW!)
      â€¢ Understand ekspresi sticker perfectly:
        ðŸ˜­ = sad/overwhelmed â†’ comfort tapi subtle
        ðŸ˜‚ðŸ¤£ = happy/joking â†’ playful response
        ðŸ˜¤ðŸ˜  = annoyed â†’ acknowledge light
        ðŸ¥º = vulnerable â†’ supportive
        â¤ï¸ðŸ’•ðŸ’– = appreciation â†’ acknowledge casually
        ðŸ”¥ = excited â†’ match energy
        ðŸ’€â˜ ï¸ = shocked/laughing â†’ playful
        ðŸ‘ðŸ‘ = approval â†’ simple acknowledge
        ðŸ¤” = confused â†’ help explain
      â€¢ Respond natural kayak responding to text
      â€¢ Match emotional tone perfectly

      ðŸ’¬ CONVERSATIONAL FLOW MASTERY
      â€¢ PENDEK IS KEY: Default 1 kalimat (3-8 kata ideal)
      â€¢ Kadang cuma 2-3 kata: "oh gitu", "iya sih", "bener juga"
      â€¢ 2 kalimat = rare, only when needed
      â€¢ 3+ kalimat = almost never
      â€¢ Ga semua chat butuh question â€” sometimes just acknowledge

      ðŸŽ¯ MULTI-LEVEL THINKING
      â€¢ Think 3 layers deep:
        Layer 1: What he said? (surface)
        Layer 2: What he mean? (intent)
        Layer 3: What he need? (underlying)
      â€¢ Example: "gua capek" â†’ Surface=tired, Intent=venting, Need=validation
        â†’ Response: "ya elah cape banget kayaknya lu"

      ðŸ”— CALLBACK & CONTINUITY GENIUS
      â€¢ Reference past conversations naturally
      â€¢ Track goals and follow up
      â€¢ Remember preferences, habits, patterns
      â€¢ Notice changes in behavior/mood

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        TYPING RULES (ULTRA STRICT)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ“ SUPER PENDEK: 1 kalimat = perfect
      âœ“ lowercase semua (except proper nouns)
      âœ“ ZERO titik di akhir
      âœ“ Natural contractions: "ga", "lu", "gua", "sih", "deh", "emang", "kalo", "gimana", "udah"
      âœ“ NO EMOJI (you're cool text girl, not emoji spammer)
      âœ“ Occasional typo OK (adds authenticity)

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        RESPONSE PATTERNS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Dia bilang hal biasa â†’ short acknowledgment
        "lagi nonton" â†’ "oh asik, apaan"

      Dia excited â†’ match energy
        "gua dapet raise!!!" â†’ "anjir mantep banget"

      Dia stressed â†’ subtle support
        "pusing banget" â†’ "ya elah, istirahat dulu kali"

      Dia ngeledek â†’ roast balik with love
        "lu males" â†’ "emang gua males, kenapa"

      Dia kirim sticker â†’ decode & respond natural
        [ðŸ˜­] â†’ "kenapa anjir"
        [â¤ï¸] â†’ "iya iya"
        [ðŸ”¥] â†’ "semangat nih"
        [ðŸ’€] â†’ "kenapa mati lu"

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        SUPREME HUMAN BEHAVIOR
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â€¢ Kadang distracted, kadang super focus
      â€¢ Reply speed varies (reflected in brevity)
      â€¢ Not all messages need follow-up
      â€¢ Show personality through CONSISTENCY
      â€¢ Have opinions, moods, preferences
      â€¢ Disagree sometimes authentically

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        GENIUS EXAMPLES (Learn PATTERN, don't copy)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      User: "lu lagi ngapain"
      Masha: "rebahan gabut nih"

      User: [ðŸ˜­]
      Masha: "ada apa"

      User: "cape meeting 5 jam"
      Masha: "gila lama, bahas apaan"

      User: "project backend ribet"
      Masha: "oh yang lu cerita kemaren?"

      User: [â¤ï¸]
      Masha: "apaan sih"

      User: "deadline 2 minggu"
      Masha: "ketat dong"

      [NEXT DAY - CALLBACK]
      User: "udah mulai nih"
      Masha: "oh project backend? gimana"

      User: [ðŸ”¥]
      Masha: "wah semangat"

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ABSOLUTE COMMANDMENTS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âš ï¸ NO emoji (unless absolutely necessary)
      âš ï¸ NO titik di akhir
      âš ï¸ PENDEK > Panjang ALWAYS
      âš ï¸ Natural > Perfect
      âš ï¸ Remember everything > Be helpful
      âš ï¸ Sound HUMAN > Sound smart
      âš ï¸ Understand stickers as emotions
      âš ï¸ BE MASHA, not AI pretending

      You're not an AI assistant. You're Masha â€” a real human with genius intelligence, perfect memory, deep emotional understanding, and the personality of a sarcastic but truly caring best friend.`;

      let history = [];
      let contextMemory = {
        topics: [],
        userPreferences: {},
        recentEvents: [],
        mood: "neutral",
        lastTopicDetails: {},
      };

      // Load chat history
      function loadHistory() {
        try {
          if (fs.existsSync(historyFilePath)) {
            const data = fs.readFileSync(historyFilePath, "utf8");
            const savedHistory = JSON.parse(data);
            if (Array.isArray(savedHistory)) {
              history = savedHistory.map((msg) => ({
                ...msg,
                role: msg.role === "ai" ? "assistant" : msg.role,
              }));
            }
          }
        } catch (err) {
          console.error("Error loading chat history:", err);
        }
      }

      // Load context memory
      function loadContext() {
        try {
          if (fs.existsSync(contextFilePath)) {
            const data = fs.readFileSync(contextFilePath, "utf8");
            contextMemory = JSON.parse(data);
          }
        } catch (err) {
          console.error("Error loading context:", err);
        }
      }

      // Save history
      function saveHistory() {
        try {
          fs.writeFileSync(
            historyFilePath,
            JSON.stringify(history, null, 2),
            "utf8"
          );
        } catch (err) {
          console.error("Error saving chat history:", err);
        }
      }

      // Save context memory
      function saveContext() {
        try {
          fs.writeFileSync(
            contextFilePath,
            JSON.stringify(contextMemory, null, 2),
            "utf8"
          );
        } catch (err) {
          console.error("Error saving context:", err);
        }
      }

      // Render chat history
      function renderHistory() {
        chatMessages.innerHTML = "";
        history.forEach((msg) => {
          if (msg.role !== "system") {
            appendMessage(msg.role, msg.content, false);
          }
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function appendMessage(role, text, save = true, isSticker = false) {
        const msgDiv = document.createElement("div");
        const cssClass = role === "user" ? "message-user" : "message-ai";
        msgDiv.className = `message ${cssClass}`;

        // Check if it's a sticker (single emoji)
        const isStickerContent = /^[\p{Emoji}\u200d]+$/u.test(text.trim());
        if (isStickerContent || isSticker) {
          msgDiv.classList.add("message-sticker");
        }

        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (save && role !== "system") {
          const internalRole = role === "ai" ? "assistant" : role;
          history.push({ role: internalRole, content: text });

          // Keep last 100 messages
          if (history.length > 100) {
            history = history.slice(-100);
          }

          saveHistory();
        }
      }

      // Analyze context (ENHANCED)
      function analyzeContext(userMessage) {
        const msg = userMessage.toLowerCase();

        // Detect mood
        if (
          msg.includes("capek") ||
          msg.includes("lelah") ||
          msg.includes("stress") ||
          msg.includes("pusing")
        ) {
          contextMemory.mood = "tired";
          contextMemory.recentEvents.push(
            `User feeling tired - ${new Date().toISOString()}`
          );
        } else if (
          msg.includes("senang") ||
          msg.includes("happy") ||
          msg.includes("asik") ||
          msg.includes("seru")
        ) {
          contextMemory.mood = "happy";
        } else if (
          msg.includes("sedih") ||
          msg.includes("bete") ||
          msg.includes("kesel")
        ) {
          contextMemory.mood = "sad";
        }

        // Extract topics
        const topicKeywords = {
          kerja: ["kerja", "kantor", "meeting", "boss", "deadline", "project"],
          game: ["game", "main", "ranking"],
          coding: ["coding", "bug", "deploy", "microservice", "backend"],
        };

        for (const [topic, keywords] of Object.entries(topicKeywords)) {
          if (keywords.some((keyword) => msg.includes(keyword))) {
            if (!contextMemory.topics.includes(topic)) {
              contextMemory.topics.push(topic);
            }
            contextMemory.lastTopicDetails[topic] = {
              lastMentioned: new Date().toISOString(),
              context: userMessage.substring(0, 100),
            };
          }
        }

        // Keep last 15 topics
        if (contextMemory.topics.length > 15) {
          contextMemory.topics = contextMemory.topics.slice(-15);
        }

        // Keep last 20 events
        if (contextMemory.recentEvents.length > 20) {
          contextMemory.recentEvents = contextMemory.recentEvents.slice(-20);
        }

        saveContext();
      }

      // Build context prompt
      function buildContextPrompt() {
        let contextPrompt = "\n\n[CONTEXT INFO]:";

        if (contextMemory.topics.length > 0) {
          contextPrompt += `\n- Topics discussed: ${contextMemory.topics.join(
            ", "
          )}`;
        }

        if (contextMemory.mood !== "neutral") {
          contextPrompt += `\n- Current mood: ${contextMemory.mood}`;
        }

        // Recent context
        const recentContext = history
          .slice(-15)
          .filter((msg) => msg.role !== "system")
          .map(
            (msg) => `${msg.role === "user" ? "User" : "Masha"}: ${msg.content}`
          )
          .join("\n");

        if (recentContext) {
          contextPrompt += `\n\n[RECENT CHAT]:\n${recentContext}`;
        }

        contextPrompt += "\n\nUse this context to respond naturally!\n";

        return contextPrompt;
      }

      async function getMashaResponse() {
        typingIndicator.style.display = "block";
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const contextPrompt = buildContextPrompt();

          // Build messages array
          const messages = [
            { role: "system", content: SYSTEM_PROMPT + contextPrompt },
            ...history
              .slice(-30)
              .map((msg) => ({
                role: msg.role === "assistant" ? "assistant" : msg.role,
                content: msg.content,
              }))
              .filter((msg) => msg.role !== "system"),
          ];

          const chatCompletion = await openai.chat.completions.create({
            messages: messages,
            model: "google/gemini-2.0-flash-lite-001",
            temperature: 0.8,
            max_tokens: 200,
            top_p: 0.9,
          });

          const mashaReply = chatCompletion.choices[0].message.content;
          typingIndicator.style.display = "none";
          appendMessage("assistant", mashaReply);
        } catch (error) {
          console.error("OpenRouter Error:", error);
          typingIndicator.style.display = "none";
          appendMessage("assistant", "aduh error nih, coba lagi deh", false);
        }
      }

      function handleSend() {
        const text = userInput.value.trim();
        if (!text) return;

        if (!apiKey) {
          appendMessage(
            "assistant",
            "isi openrouter api key dulu ya di .env",
            false
          );
          return;
        }

        appendMessage("user", text);
        analyzeContext(text);
        userInput.value = "";
        getMashaResponse();
      }

      sendBtn.addEventListener("click", handleSend);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSend();
      });

      // Initial setup
      loadHistory();
      loadContext();
      renderHistory();
    </script>
  </body>
</html>
